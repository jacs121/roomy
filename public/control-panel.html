<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket Chat - Control Panel</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #clientList, #messages { border: 1px solid #ccc; padding: 10px; margin-top: 10px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .message { display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background-color: red; color: white; border: none; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Control Panel</h1>
    <input type="text" id="newPath" placeholder="New path (e.g. Main/Sub1)">
    <button onclick="addRoom()">Add Room</button>
    <select id="pathSelect" onchange="await fetchRoomData()"></select>

    <button onclick="await clearMessages()">Clear Messages</button>
    <button onclick="await saveChat()">Save Chat</button>
    <button onclick="await updateClients()">Update Clients</button>
    <input type="checkbox" id="anonymous">anonymous
    
    <h2>Connected Clients</h2>
    <div id="clientList"></div>

    <h2>Chat Messages</h2>
    <div id="messages"></div>

    <script>
        let selectedPath = ""

        async function loadPaths() {
            let res = await fetch('/paths', {method: 'GET'});
            let paths = await res.json();
            let pathSelect = document.getElementById('pathSelect');
    
            function renderPaths(node, prefix = "") {
                return Object.keys(node).map(key => {
                    if (key === "__room") return "";
                    let newPath = prefix ? `${prefix}/${key}` : key;
                    return `<option value="${newPath}">${newPath}</option>` + renderPaths(node[key], newPath);
                }).join('');
            }
    
            pathSelect.innerHTML = renderPaths(paths);
        }

        async function fetchRoomData() {
            selectedPath = document.getElementById("pathSelect").value;
            await updateClients();
            await fetchMessages();
        }
    
        function addRoom() {
            fetch('/add-room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: document.getElementById('newPath').value })
            }).then(loadPaths);
        }


        document.getElementById("anonymous").addEventListener("change", async (event) => {
            console.log(event.target.checked)
            await fetch(`/anonymous/${selectedPath}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({anonymous: event.target.checked})
            })
        })

        async function updateClients() {
            await fetch(`/clients/${selectedPath}`, {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                const clientListElement = document.getElementById('clientList');
                clientListElement.innerHTML = '';
                data.forEach(client => {
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${client.username}</strong>
                        <button onclick="kickClient('${client.clientId}')">Kick</button>
                        <button onclick="banClient('${client.ip}')">Ban</button>
                        <button onclick="globalBanClient('${client.ip}')">GL Ban</button>`;
                    clientListElement.appendChild(div);
                });
            });
        }

        async function fetchMessages() {
            await fetch(`/chat-logs/${selectedPath}`, {method: 'GET'})
                .then(response => response.json())
                .then(messages => {
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.innerHTML = `<strong>${msg.username}:</strong> ${msg.text}`;
                        messagesContainer.appendChild(div);
                    });
                });
        }

        function banClient(ip) {
            fetch(`/ban-client/${selectedPath}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip })
            }).then(() => updateClients());
        }

        function globalBanClient(ip) {
            fetch(`/gl-ban-client/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip })
            }).then(() => updateClients());
        }
        
        async function clearMessages() {
            await fetch(`/clear-messages/${selectedPath}`, { method: 'GET' })
                .then(() => document.getElementById('messages').innerHTML = '');
        }
    
        async function saveChat() {
            await fetch('/save-chat', { method: 'GET' })
            .then(response => response.json())
            .then(data => alert(data.message));
        }
        
        function kickClient(clientId) {
            fetch(`/kick-client/${selectedPath}`, {  // Send request with room path
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clientId })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                updateClients();  // Refresh the client list
            });
        }

        loadPaths();
    </script>

</body>
</html>
